---
title: "Modeling Changes in Microbiome"
output:
  workflowr::wflow_html:
    toc: true
editor_options:
  chunk_output_type: console
---

This page contains the investigation of the changes over time.

```{r data, include=FALSE, echo=FALSE}

# load packages
source("code/load_packages.R")

# get data
source("code/get_cleaned_data.R")

theme_set(theme_bw())
pal = "Set1"
scale_colour_discrete <-  function(palname=pal, ...){
  scale_colour_brewer(palette=palname, ...)
}
scale_fill_discrete <-  function(palname=pal, ...){
  scale_fill_brewer(palette=palname, ...)
}

knitr::opts_chunk$set(out.width = "225%")

```


# Data prep

This is only to recode some variables to ease interpretation.

```{r}

microbiome_data$meta.dat <- microbiome_data$meta.dat %>%
  mutate(intB = ifelse(Intervention=="B", 1,0),
         time = as.numeric(Week) - 1,
         female = ifelse(Gender == "F", 1, 0),
         hispanic = ifelse(Ethnicity %in% c("White", "Asian", "Native America"), 1, 0))

```



# Phylum Level Microbiome and Intervention

We will build up to the effect of the intervention by investigating covariates to see if we can exclude them from model with intervention.
Due to only having 11 people, we will only estimate 1 random effect per model (random intercepts).
All other effects are fixed, but we will only estimate up to 2 effects.
Meaning we can only include two covariates in each model at a time.

In all models, $h(.)$ is an arbitrary link function.
We selected the Poisson model for the outcomes so the link function is the *log link*. 

For all significance test, we will use $p < 0.05$ as the level to declare significance, but we will largely focus on magnitude of effects.

## Unconditional Model

This is a random intercepts model (worst case).
No covariates are included.

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + r_{ij}\\
\beta_{0j}&= \gamma_{00} + u_{0j}\\
\end{align*}

```{r}

phylum.fit0 <- glmm_microbiome(mydata=microbiome_data,model.number=0,
                               taxa.level="Phylum", link="poisson",
                               model="1 + (1|SubjectID)")

```

## Fixed Effect of Time

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}*(Week)_{ij}+ r_{ij}\\
\beta_{0j}&= \gamma_{00} + u_{0j}\\
\beta_{1j}&= \gamma_{10}\\
\end{align*}


```{r}


phylum.fit1 <- glmm_microbiome(mydata=microbiome_data,model.number=1,
                               taxa.level="Phylum", link="poisson",
                               model="1 + time + (1|SubjectID)")

```

So, we found that time does significantly influence at least some of the bacteria over time.
This is contrary to the results when we used the normal theory model.

## Covariates: Time + Gender

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}*(Week)_{ij} + r_{ij}\\
\beta_{0j}&= \gamma_{00} + \gamma_{01}(Gender)_{j} + u_{0j}\\
\beta_{1j}&= \gamma_{10}\\
\end{align*}

Gender is coded as female (effect of being female compared to males).

```{r}


phylum.fit2 <- glmm_microbiome(mydata=microbiome_data,model.number=2,
                               taxa.level="Phylum", link="poisson",
                               model="1 + time + female + (1|SubjectID)")
```

Controlling for the effect of time, Gender was only signficant for *Bacteroidetes* and *Firmicutes*. 
We will take out gender out of model to test other effects, but will come back when testing intervention.

## Covariates: Time + Ethnicity

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}*(Week)_{ij}+ r_{ij}\\
\beta_{0j}&= \gamma_{00} + \gamma_{01}(Ethnicity)_{j} + u_{0j}\\
\beta_{1j}&= \gamma_{10}\\
\end{align*}

Ethnicity is coded as Hispanic (effect of being Hispanic compared to White, Asian or Native American).
Groups were coded this way due to sample size.

```{r}


phylum.fit3 <- glmm_microbiome(mydata=microbiome_data,model.number=3,
                               taxa.level="Phylum", link="poisson",
                               model="1 + time + hispanic + (1|SubjectID)")
```

Controlling for the effect of time, Ethnicity was not significant for all Phylum.

## Effect of Intervention

Next, we invested the effect of intervention, however, the results are parsed between which covariates are included in the model.

Intervention was coded as (group A = 0, and group B = 1).
So, the results are interpretted as the effect of being in intervention group B.


### Covariate(s): Time

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}*(Week)_{ij} + r_{ij}\\
\beta_{0j}&= \gamma_{00} + \gamma_{01}(Intervention)_{j} + u_{0j}\\
\beta_{1j}&= \gamma_{10}\\
\end{align*}

The effect of intervention is the main outcome of this study.

```{r}


phylum.fit4 <- glmm_microbiome(mydata=microbiome_data,model.number=4,
                               taxa.level="Phylum", link="poisson",
                               model="1 + intB + time + (1|SubjectID)")
```

Controlling for the effect of time, the intervention resulted in a significant increase in abundance of Phylums: *Euryarchaeota*.
This is in contrast to the effect of time, which was negatively associated with abundance.
So, abundance of *Euryarchaeota* increased in intervention group B but not in group A.

Other interesting but not significant results.
The effect of the intervention was in the opposite direction (positive) compared to the effect of time (negative) is Phylums: *Actinobacteria*, *Firmicutes*, *Lentisphaerae*, and *Tenericutes*.


### Covariate(s): Time by intervention interaction

Here, the model tests whether the effect of the intervention is constant across time or does the effect of the intervention get stronger (or weaker) at time progress.
And remember, time is coded 0, 1, 2, 3, so a 1 unit increase in time corresponds to 1 month or 4 weeks of the intervention.

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}(Week)_{ij}  + r_{ij}\\
\beta_{0j}&= \gamma_{00} + \gamma_{01}(Intervention)_{j} + u_{0j}\\
\beta_{1j}&= \gamma_{10} + \gamma_{11}(Intervention)_{j}\\
\end{align*}

It could be that the intervention is directly related to time so included a *average effect of time* through the main effect effect is just adding more parameters and is not informative.
If the effect of the intervention is still essentially zero, we will re-estimate the model without the main effect.

```{r}


phylum.fit5 <- glmm_microbiome(mydata=microbiome_data,model.number=5,
                               taxa.level="Phylum", link="poisson",
                               model="1 + intB + time + intB:time + (1|SubjectID)")
```

### Covariate(s): Time by intervention interaction (only)

Only the interaction term.

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}(Week)_{ij}+ r_{ij}\\
\beta_{0j}&= \gamma_{00} + u_{0j}\\
\beta_{1j}&= \gamma_{10} + \gamma_{11}(Intervention)_{j}\\
\end{align*}


```{r}


phylum.fit6 <- glmm_microbiome(mydata=microbiome_data,model.number=6,
                               taxa.level="Phylum", link="poisson",
                               model="1 + time + intB:time + (1|SubjectID)")
```


### Covariate(s): Time and Gender

\begin{align*}
h\left(Y_{ij}\right)&=\beta_{0j} + \beta_{1j}(Week)_{ij}  + r_{ij}\\
\beta_{0j}&= \gamma_{00} + \gamma_{01}(Intervention)_{j} + \gamma_{02}(Gender)_{j} + u_{0j}\\
\beta_{1j}&= \gamma_{10}\\
\beta_{2j}&= \gamma_{20}\\
\end{align*}


```{r}

phylum.fit7 <- glmm_microbiome(mydata=microbiome_data, model.number=7,
                               taxa.level="Phylum", link="poisson",
                               model="1 + intB + time + female + (1|SubjectID)")
```

# Microbiome Figure

```{r}

mphyseq = psmelt(phylo_data)
mphyseq2 <- mphyseq %>%
  dplyr::group_by(SubjectID, Week) %>%
  dplyr::mutate(Total = sum(Abundance)) %>%
  dplyr::ungroup()%>%
  dplyr::group_by(SubjectID, Week, Phylum) %>%
  dplyr::mutate(PhylumAbund = sum(Abundance),
                RelAbund = PhylumAbund/Total)
  
mphyseq2 <- mphyseq2 %>% distinct(SubjectID, Week, Phylum, .keep_all = T)

keepVar <- c("SubjectID", "Week", "Intervention", "Phylum", "PhylumAbund", "RelAbund")

mphyseq2 <- mphyseq2[, keepVar]

# take out "__" at start of names
mphyseq2$Phylum <- substring(mphyseq2$Phylum, 3)

# get right number of colors for plotting
no_cols <- length(unique(mphyseq2$Phylum))

## Some Colors
colors_micro <- rev(c("grey90", rev(c("#00a2f2",  "#c91acb", "#7f5940", "#cc5200", "#00d957", "#40202d", "#e60099", "#006fa6", "#f29d3d", "#300059"))))

# Now get the intervention by time model
fe <- phylum.fit5$`Fixed Effects`$Actinobacteria
fe[,2]

get.data.with.trend <- function(data, fit){
  data$Y <- 0
  ph <- names(fit[[1]])
  i <- 1
  for(i in 1:length(ph)){
    
    fe <- phylum.fit5[[1]][[ph[i]]][,2]
  
    dat <- filter(data, Phylum == ph[i])
    
    Y <- exp(fe[1] + fe[2]*as.numeric(as.factor(dat$Intervention)) + fe[3]*(as.numeric(dat$Week) - 1) + fe[4]*as.numeric(as.factor(dat$Intervention))*(as.numeric(dat$Week) - 1))
    
    data$Y[data$Phylum == ph[i]] <- Y
  }
  
  return(data)
}
  
micro_data <- get.data.with.trend(mphyseq2, phylum.fit5)
micro_data$Week <- (as.numeric(micro_data$Week)-1)*4

p <- ggplot(micro_data, aes(Week, PhylumAbund))+
  geom_jitter(height=0, width=0.25) +
  #geom_line(data=micro_data, aes(x=Week, y=Y, group=Intervention, color=Intervention)) +
  facet_wrap(.~Phylum, ncol = 5, scales = "free") +
  labs(y="Phylum Abundance") +
  theme(panel.grid = element_blank(),
        strip.background =element_blank(), 
        legend.position = "bottom")


p

```

